<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TAMP.OTP</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;background:#0b0e14;color:#fff;font-family:system-ui}
.card{background:#161a22;margin:12px;padding:14px;border-radius:14px}
.hide{display:none}
input,button{padding:10px;border-radius:8px;border:none}
button{cursor:pointer}
.menu{background:#161a22;padding:12px;border-radius:12px}
.row{background:#10131a;padding:10px;border-radius:12px;margin-bottom:8px;display:flex;gap:8px}
.otp-input{width:80px;text-align:center;color:#22c55e;background:#0f172a;border:2px solid #22c55e;font-weight:700}
</style>
</head>

<body>

<!-- AUTH -->
<div class="card" id="authBox">
<h3>Login / Register</h3>
<input id="email" placeholder="Email"><br><br>
<input id="pass" placeholder="Password"><br><br>
<button onclick="login()">Login</button>
<button onclick="register()">Register</button>
</div>

<!-- NAV -->
<div class="card hide" id="app">
<b>TAMP.OTP</b>
<button onclick="menu.classList.toggle('hide')">â˜°</button>

<div class="menu hide" id="menu">
<div>ðŸ’° Balance â‚¹<b id="bal">0</b></div>
<div>ðŸ“¦ Buy <b id="buy">0</b></div>
<div>âœ… Success <b id="succ">0</b></div>
<hr>
<div id="adminBox" class="hide">
<h4>Admin</h4>
<div id="users"></div>
</div>
<hr>
<button onclick="logout()" style="background:#ef4444;color:#fff;width:100%">Logout</button>
</div>
</div>

<div class="card hide" id="adminMail">
<input id="mail" placeholder="Add Mail">
<button onclick="addMail()">Add</button>
</div>

<div class="card hide" id="buyBox">
<button onclick="buyMail()">BUY MAIL (â‚¹1)</button>
</div>

<div id="chat"></div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDi40uxY5aC8R3xqacPL393h67TuQ4RiVo",
  databaseURL:"https://real-time-chat-box-179ea-default-rtdb.firebaseio.com"
});
const db=firebase.database();
const PRICE=1;

const ADMIN_EMAIL="admin@tampotp.com";
const ADMIN_PASS="admin@123";

let uid=localStorage.getItem("uid");
let isAdmin=false;

/* AUTH */
function register(){
  if(!email.value||!pass.value) return alert("Fill all");
  uid="u"+Date.now();
  db.ref("users/"+uid).set({
    email:email.value, pass:pass.value,
    balance:0, buy:0, success:0, lastActive:Date.now()
  });
  localStorage.setItem("uid", uid);
  location.reload();
}

function login(){
  if(email.value===ADMIN_EMAIL && pass.value===ADMIN_PASS){
    uid="ADMIN";
    isAdmin=true;
    localStorage.setItem("uid", uid);
    localStorage.setItem("admin", "1");
    location.reload();
    return;
  }
  db.ref("users").once("value", s=>{
    let ok=false;
    s.forEach(u=>{
      if(u.val().email===email.value && u.val().pass===pass.value){
        uid=u.key; ok=true;
      }
    });
    if(!ok) return alert("Wrong login");
    localStorage.setItem("uid", uid);
    location.reload();
  });
}

function logout(){
  localStorage.clear();
  location.reload();
}

/* AUTO LOGIN */
if(uid){
  authBox.classList.add("hide");
  app.classList.remove("hide");
  buyBox.classList.remove("hide");
  if(localStorage.getItem("admin")) isAdmin=true;
  db.ref("users/"+uid+"/lastActive").set(Date.now());
}

/* USER DATA */
if(!isAdmin && uid){
  db.ref("users/"+uid).on("value", s=>{
    const d = s.val()||{};
    bal.innerText=d.balance||0;
    buy.innerText=d.buy||0;
    succ.innerText=d.success||0;
  });
}

/* ADMIN PANEL */
if(isAdmin){
  adminBox.classList.remove("hide");
  adminMail.classList.remove("hide");

  db.ref("users").on("value", s=>{
    users.innerHTML="";
    s.forEach(u=>{
      users.innerHTML+=`
      <div style="font-size:12px">
        ${u.val().email} â‚¹${u.val().balance}
        <button onclick="addMoney('${u.key}')">+â‚¹</button>
      </div>`;
    });
  });
}

function addMoney(id){
  const a=Number(prompt("Add INR"));
  if(!a) return;
  db.ref("users/"+id+"/balance").transaction(b=>(b||0)+a);
}

/* MAIL */
function addMail(){
  if(!mail.value) return;
  db.ref("lot").push(mail.value);
  mail.value="";
}

function buyMail(){
  db.ref("users/"+uid+"/balance").once("value", s=>{
    if((s.val()||0)<PRICE) return alert("No balance");
    db.ref("lot").limitToFirst(1).once("value", x=>{
      if(!x.exists()) return alert("No mail");
      let m,k;
      x.forEach(v=>{m=v.val(); k=v.key;});
      db.ref("lot/"+k).remove();
      db.ref("msg").push({email:m, otp:"", user:uid, time:Date.now()});
      db.ref("users/"+uid+"/balance").transaction(b=>b-PRICE);
      db.ref("users/"+uid+"/buy").transaction(n=>(n||0)+1);
    });
  });
}

/* SHOW OTP */
db.ref("msg").on("child_added", s=>{
  const d = s.val();
  const r = document.createElement("div");
  r.className="row";
  r.id = s.key;
  r.innerHTML = `
    <b>${d.email}</b>
    <input class="otp-input" ${isAdmin?"":"disabled"} value="${d.otp||""}">
  `;

  // ADMIN OTP EDIT
  if(isAdmin){
    const otpInput = r.querySelector("input");
    otpInput.oninput = e=>{
      db.ref("msg/"+s.key+"/otp").set(e.target.value);
      db.ref("users/"+d.user+"/success").transaction(n=>(n||0)+1);
    };
  }

  chat.prepend(r);
});

/* LIVE OTP FOR USERS */
db.ref("msg").on("child_changed", s=>{
  const r = document.getElementById(s.key);
  if(!r) return;
  const otpInput = r.querySelector("input");
  if(!isAdmin){
    otpInput.value = s.val().otp||"";
  }
});
</script>

</body>
</html>
