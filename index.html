<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TAMP.OTP FINAL</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
 --bg:#0b0e14;
 --card:#161a22;
 --soft:#10131a;
 --accent:#22c55e;
 --danger:#ef4444;
 --text:#fff;
}
*{box-sizing:border-box}
body{
 margin:0;
 background:var(--bg);
 color:var(--text);
 font-family:system-ui;
}
.card{
 background:var(--card);
 margin:12px;
 padding:14px;
 border-radius:16px;
 box-shadow:0 0 20px rgba(0,0,0,.4);
}
.hide{display:none}
input,select,button{
 padding:10px;
 border-radius:10px;
 border:none;
 background:#0f1320;
 color:#fff;
}
input:focus,select:focus{
 outline:none;
 box-shadow:0 0 0 2px #22c55e55;
}
button{cursor:pointer}

.row{
 background:var(--soft);
 padding:10px;
 border-radius:14px;
 margin-bottom:8px;
 display:flex;
 gap:8px;
 align-items:center;
 justify-content:space-between;
 transition:.2s;
}
.row:hover{background:#151a24}

.copy{
 background:linear-gradient(135deg,#22c55e,#16a34a);
 color:#000;
 font-weight:600;
}

.buyNext{
 background:linear-gradient(135deg,#4f8cff,#2563eb);
 color:#fff;
 font-weight:600;
}
.buyNext:disabled{
 opacity:.4;
 cursor:not-allowed;
}

.otp{
 width:80px;
 text-align:center;
 color:#f87171;
 background:#0f1320;
 border:1px solid var(--accent);
 border-radius:6px;
 font-weight:700;
}

.time{font-size:12px;color:#fca5a5}
.topbar{
 display:flex;
 justify-content:space-between;
 align-items:center;
}
.logout{
 background:var(--danger);
 color:#fff;
 font-weight:600;
}
</style>
</head>

<body>

<!-- AUTH -->
<div class="card" id="auth">
<h3>Login / Register</h3>
<input id="email" placeholder="Email"><br><br>
<input id="pass" placeholder="Password"><br><br>
<button onclick="login()">Login</button>
<button onclick="register()">Register</button>
</div>

<!-- APP -->
<div id="app" class="hide">

<div class="card topbar">
<b>TAMP.OTP</b>
<button class="logout" onclick="logout()">Logout</button>
</div>

<!-- ADMIN -->
<div id="adminBox" class="card hide">
<h3>ADMIN PANEL</h3>

<h4>Domains</h4>
<input id="newDomain" placeholder="@gmail.com">
<button onclick="addDomain()">Add / Update Domain</button><br><br>

<select id="adminDomain"></select><br><br>
<input id="adminMail" placeholder="Username or full email">
<button onclick="addMail()">Add Mail</button>

<h4>Domain Stock</h4>
<div id="stocks"></div>

<h4>Users</h4>
<div id="users"></div>
</div>

<!-- USER -->
<div id="userBox" class="card hide">
<h3>User Panel</h3>
<div>Balance ₹<b id="bal">0</b></div><br>
<select id="userDomain">
<option value="">-- Select Domain --</option>
</select>
<button onclick="buyMail()">Buy Mail ₹1</button>
</div>

<div id="list"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyDi40uxY5aC8R3xqacPL393h67TuQ4RiVo",
 databaseURL:"https://real-time-chat-box-179ea-default-rtdb.firebaseio.com"
});
const db=firebase.database();

let uid="",isAdmin=false;
const PRICE=1,EXPIRE=600000;

/* LOGIN */
function login(){
 let e=email.value,p=pass.value;
 if(e==="admin@tampotp.com" && p==="admin@123"){
  localStorage.uid="admin";location.reload();return;
 }
 db.ref("users").once("value",s=>{
  let ok=false;
  s.forEach(u=>{
   if(u.val().email===e && u.val().pass===p){
    uid=u.key;ok=true;
   }
  });
  if(!ok) return alert("Wrong login");
  localStorage.uid=uid;location.reload();
 });
}

/* REGISTER */
function register(){
 if(!email.value||!pass.value) return alert("Fill all");
 db.ref("users").once("value",s=>{
  let ex=false;
  s.forEach(u=>{if(u.val().email===email.value) ex=true});
  if(ex) return alert("Email exists");
  let id="u"+Date.now();
  db.ref("users/"+id).set({
   email:email.value,pass:pass.value,
   balance:0,buy:0,success:0,blocked:false
  });
  localStorage.uid=id;location.reload();
 });
}

function logout(){localStorage.clear();location.reload()}

/* AUTO LOGIN */
uid=localStorage.uid||"";
if(uid){
 auth.classList.add("hide");
 app.classList.remove("hide");
 if(uid==="admin"){isAdmin=true;adminBox.classList.remove("hide");}
 else{userBox.classList.remove("hide");}
}

/* LOAD DOMAINS */
db.ref("domains").on("value",s=>{
 adminDomain.innerHTML="";
 userDomain.innerHTML='<option value="">-- Select Domain --</option>';
 stocks.innerHTML="";
 s.forEach(d=>{
  adminDomain.innerHTML+=`<option value="${d.key}">${d.val().name}</option>`;
  userDomain.innerHTML+=`<option value="${d.key}">${d.val().name} (${d.val().stock||0})</option>`;
  stocks.innerHTML+=`${d.val().name} → ${d.val().stock||0}<br>`;
 });
});

/* ADD DOMAIN */
function addDomain(){
 let d=newDomain.value.trim();
 if(!d.startsWith("@")) return alert("Use @domain.com");
 let key=d.replace(".","_");
 db.ref("domains/"+key).set({name:d,stock:0});
 newDomain.value="";
}

/* ADD MAIL (ADMIN) */
function addMail(){
 let k=adminDomain.value,v=adminMail.value.trim();
 if(!k||!v) return alert("Fill all");
 db.ref("domains/"+k).once("value",s=>{
  let dom=s.val().name;
  let email=v.includes("@")?v:v+dom;
  let safe=email.replace(/[.#$/\[\]]/g,"_");
  db.ref("mails/"+k+"/"+safe).set(true);
  db.ref("domains/"+k+"/stock").transaction(n=>(n||0)+1);
  adminMail.value="";
 });
}

/* USER BALANCE */
db.ref("users/"+uid).on("value",s=>{
 if(s.exists()){
  bal.innerText=s.val().balance||0;
  if(s.val().blocked){alert("You are blocked");logout();}
 }
});

/* BUY FIRST MAIL */
function buyMail(){
 let k=userDomain.value;
 if(!k) return alert("Select domain");
 buyNextSameDomain(k);
}

/* BUY NEXT SAME DOMAIN (SEQUENCE) */
function buyNextSameDomain(domainKey,btn){
 db.ref("users/"+uid+"/balance").once("value",s=>{
  if((s.val()||0)<PRICE) return alert("No balance");
  db.ref("mails/"+domainKey).orderByKey().limitToFirst(1).once("value",x=>{
   if(!x.exists()) return alert("No mail in domain");
   let key;
   x.forEach(m=>key=m.key);
   db.ref("mails/"+domainKey+"/"+key).remove();
   db.ref("domains/"+domainKey+"/stock").transaction(n=>(n||0)-1);
   db.ref("msg").push({
    email:key.replace(/_/g,"."),
    user:uid,
    time:Date.now(),
    otp:""
   });
   db.ref("users/"+uid+"/balance").transaction(b=>b-PRICE);
   if(btn) btn.disabled=true;
  });
 });
}

/* SHOW MAILS */
db.ref("msg").on("child_added",s=>{
 let d=s.val();
 if(d.user!==uid && !isAdmin) return;

 let r=document.createElement("div");
 r.className="row";
 let domainKey=d.email.split("@")[1].replace(".","_");

 r.innerHTML=`
 <button class="copy">Copy</button>
 <span>${d.email.replace(/^(.{3}).*(.{2}@)/,"$1*****$2")}</span>
 <input class="otp" ${isAdmin?"":"disabled"}>
 <span class="time">10:00</span>
 <button class="buyNext">Buy Next</button>
 `;

 r.querySelector(".copy").onclick=()=>navigator.clipboard.writeText(d.email);

 if(isAdmin){
  r.querySelector(".otp").oninput=e=>
   db.ref("msg/"+s.key+"/otp").set(e.target.value);
 }

 db.ref("msg/"+s.key+"/otp").on("value",snap=>{
  r.querySelector(".otp").value=snap.val()||"";
 });

 r.querySelector(".buyNext").onclick=()=>{
  buyNextSameDomain(domainKey,r.querySelector(".buyNext"));
 };

 list.prepend(r);
 startTimer(d.time,r.querySelector(".time"),s.key);
});

/* TIMER */
function startTimer(t,el,id){
 let x=setInterval(()=>{
  let l=EXPIRE-(Date.now()-t);
  if(l<=0){clearInterval(x);db.ref("msg/"+id).remove();}
  el.innerText=
   String(Math.floor(l/60000)).padStart(2,"0")+":"+
   String(Math.floor(l/1000)%60).padStart(2,"0");
 },1000);
}
</script>
</body>
</html>
